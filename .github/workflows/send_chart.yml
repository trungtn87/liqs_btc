import os
import asyncio
from pathlib import Path
import requests
from playwright.async_api import async_playwright

# === CONFIG ===
# === CONFIG ===
COINGLASS_URL = "https://www.coinglass.com/vi/pro/futures/LiquidationHeatMap"
DOWNLOAD_DIR = Path("./screenshots")
TELEGRAM_BOT_TOKEN = os.getenv("BOT_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("CHAT_ID") 




async def capture_chart_and_send():
    DOWNLOAD_DIR.mkdir(exist_ok=True)

    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        context = await browser.new_context(accept_downloads=True)
        page = await context.new_page()

        print("üîÑ ƒêang m·ªü trang Coinglass...")
        await page.goto(COINGLASS_URL)
        await page.wait_for_timeout(5000)

        # Click n√∫t "K√Ω hi·ªáu"
        try:
            print("üîÅ ƒêang t√¨m n√∫t 'K√Ω hi·ªáu'...")
            await page.wait_for_selector("button", timeout=10000)
            symbol_button = await page.locator("button", has_text="K√Ω hi·ªáu").first
            if await symbol_button.is_visible():
                print("üü¢ Nh·∫•n n√∫t 'K√Ω hi·ªáu'...")
                await symbol_button.click()
                await page.wait_for_timeout(3000)
            else:
                print("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y n√∫t 'K√Ω hi·ªáu'")
        except Exception as e:
            print(f"‚ùå L·ªói khi nh·∫•n 'K√Ω hi·ªáu': {e}")
            await browser.close()
            return

        # T√¨m v√† nh·∫•n n√∫t SVG (ch·ª•p ·∫£nh)
        print("üì∏ T√¨m v√† nh·∫•n n√∫t ch·ª•p ·∫£nh SVG...")
        buttons = await page.query_selector_all("button")
        download = None
        for btn in buttons:
            inner_html = await btn.inner_html()
            if "<svg" in inner_html.lower():
                try:
                    async with page.expect_download(timeout=10000) as download_info:
                        await btn.click()
                    download = await download_info.value
                    break
                except:
                    continue

        if not download:
            print("‚ùå Kh√¥ng t√¨m th·∫•y n√∫t ch·ª•p ·∫£nh ho·∫∑c kh√¥ng th·ªÉ click.")
            await browser.close()
            return

        print("‚¨áÔ∏è ƒêang t·∫£i ·∫£nh v·ªÅ...")
        file_path = DOWNLOAD_DIR / "chart.png"
        await download.save_as(file_path)

        print(f"üì§ G·ª≠i ·∫£nh {file_path} l√™n Telegram...")
        with open(file_path, "rb") as img:
            response = requests.post(
                f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendPhoto",
                data={"chat_id": TELEGRAM_CHAT_ID},
                files={"photo": img}
            )

        if response.status_code == 200:
            print("‚úÖ ƒê√£ g·ª≠i th√†nh c√¥ng!")
            os.remove(file_path)
            print("üóëÔ∏è ƒê√£ xo√° ·∫£nh.")
        else:
            print(f"‚ùå G·ª≠i ·∫£nh th·∫•t b·∫°i: {response.status_code}, {response.text}")

        await browser.close()


if __name__ == "__main__":
